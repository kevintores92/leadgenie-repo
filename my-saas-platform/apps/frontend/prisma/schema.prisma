generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contact {
  id                 String               @id @default(cuid())
  brandId            String
  organizationId     String?
  firstName          String
  lastName           String?
  phone              String
  phoneNumber        String?
  phone2             String?
  phone3             String?
  phone4             String?
  phone5             String?
  verifiedNumber     String?
  lineType           String?
  propertyAddress    String?
  propertyCity       String?
  propertyState      String?
  propertyZip        String?
  propertyCounty     String?
  mailingAddress     String?
  mailingUnit        String?
  mailingCity        String?
  mailingState       String?
  mailingZip         String?
  mailingCounty      String?
  assignedNumberId   String?
  status             String?
  nextEligibleAt     DateTime?
  aiScore            Decimal?
  tags               String[]             @default([])
  updatedAt          DateTime
  createdAt          DateTime             @default(now())
  CallLog            CallLog[]
  PhoneNumber        PhoneNumber?         @relation(fields: [assignedNumberId], references: [id])
  Brand              Brand                @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Organization       Organization?        @relation(fields: [organizationId], references: [id])
  ContactAudit       ContactAudit[]
  ContactCustomField ContactCustomField[]
  Message            Message[]

  @@unique([brandId, phone])
  @@unique([organizationId, phoneNumber])
  @@index([brandId])
}

model Activity {
  id             String       @id
  organizationId String
  userId         String?
  type           String
  message        String
  meta           Json?
  createdAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Brand {
  id                    String                  @id
  orgId                 String
  name                  String
  twilioSubaccountSid   String?
  subaccountAuthToken   String?
  callingMode           String
  aiVoicePlatformUrl    String?
  createdAt             DateTime                @default(now())
  Organization          Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  CallLog               CallLog[]
  Campaign              Campaign[]
  Contact               Contact[]
  CustomFieldDefinition CustomFieldDefinition[]
  Message               Message[]
  PhoneNumber           PhoneNumber[]
  User                  User[]
}

model CallLog {
  id         String   @id
  brandId    String
  contactId  String
  callSid    String   @unique
  duration   Int?
  status     String?
  transcript String?
  createdAt  DateTime @default(now())
  Brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

model Campaign {
  id                String         @id
  brandId           String
  userId            String?
  name              String
  callingMode       String
  status            CampaignStatus @default(DRAFT)
  pausedReason      String?
  templatePrimary   String?
  templateAlternate String?
  batchSize         Int?
  intervalMinutes   Int?
  createdAt         DateTime       @default(now())
  Brand             Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  User              User?          @relation(fields: [userId], references: [id])
}

model ContactAudit {
  id              String   @id
  contactId       String
  changedByUserId String?
  changedBy       String?
  action          String   @default("UPDATE")
  changes         Json
  createdAt       DateTime @default(now())
  Contact         Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
}

model ContactCustomField {
  id                    String                @id
  contactId             String
  fieldDefinitionId     String
  value                 Json
  createdAt             DateTime              @default(now())
  Contact               Contact               @relation(fields: [contactId], references: [id], onDelete: Cascade)
  CustomFieldDefinition CustomFieldDefinition @relation(fields: [fieldDefinitionId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([fieldDefinitionId])
}

model CustomFieldDefinition {
  id                 String               @id
  brandId            String
  name               String
  type               String
  createdAt          DateTime             @default(now())
  ContactCustomField ContactCustomField[]
  Brand              Brand                @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model Message {
  id            String           @id
  brandId       String
  contactId     String
  direction     MessageDirection
  status        MessageStatus
  channel       MessageChannel
  fromNumber    String
  toNumber      String
  body          String?
  sentAt        DateTime?
  twilioSid     String?          @unique
  isAiGenerated Boolean          @default(false)
  createdAt     DateTime         @default(now())
  Brand         Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Contact       Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

model Organization {
  id                      String                    @id
  name                    String
  createdAt               DateTime                  @default(now())
  walletBalance           Float                     @default(0.0)
  aiRepliesEnabled        Boolean                   @default(false)
  aiCallsEnabled          Boolean                   @default(false)
  plan                    Plan                      @default(STARTER)
  marketplaces            String[]                  @default([])
  areaCode                String?
  timeZone                String?
  pricingMarkupPercent    Int                       @default(30)
  Activity                Activity[]
  Brand                   Brand[]
  Contact                 Contact[]
  SendingNumber           SendingNumber[]
  Usage                   Usage[]
  User                    User[]
  wallet                  OrganizationWallet?
  subscription            OrganizationSubscription?
}

model PhoneNumber {
  id             String    @id
  brandId        String
  organizationId String?
  number         String    @unique
  areaCode       String?
  assignedAt     DateTime?
  label          String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  Contact        Contact[]
  Brand          Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model SendingNumber {
  id             String       @id
  organizationId String
  phoneNumber    String       @unique
  label          String?
  enabled        Boolean      @default(true)
  lastUsedAt     DateTime?
  lastUsedCount  Int          @default(0)
  createdAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Usage {
  id             String       @id
  organizationId String
  type           String
  cost           Float
  createdAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model User {
  id            String       @id
  orgId         String
  activeBrandId String?
  username      String       @unique
  passwordHash  String?
  createdAt     DateTime     @default(now())
  Campaign      Campaign[]
  Brand         Brand?       @relation(fields: [activeBrandId], references: [id])
  Organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}

enum MessageChannel {
  SMS
  MANUAL
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  OUTBOUND_API
  OUTBOUND_MANUAL
  QUEUED
  SENT
  DELIVERED
  FAILED
}

enum Plan {
  STARTER
  PRO
}

model OrganizationWallet {
  id              String                 @id @default(uuid())
  organizationId  String                 @unique
  balanceCents    Int                    @default(0)
  isFrozen        Boolean                @default(false)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  organization    Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions    WalletTransaction[]
}

model WalletTransaction {
  id             String                 @id @default(uuid())
  walletId       String
  organizationId String
  type           WalletTransactionType
  amountCents    Int
  referenceId    String?
  createdAt      DateTime               @default(now())
  wallet         OrganizationWallet     @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([walletId])
}

model OrganizationSubscription {
  id               String               @id @default(uuid())
  organizationId   String               @unique
  provider         BillingProvider
  providerSubId    String               @unique
  planId           String
  status           SubscriptionStatus
  currentPeriodEnd DateTime
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

enum WalletTransactionType {
  PAYMENT_TOPUP
  MESSAGE_DEBIT
  REFUND
  ADJUSTMENT
}

enum BillingProvider {
  PAYPAL
  STRIPE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

model WebhookEvent {
  id        String   @id @default(uuid())
  externalId String   @unique
  type      String
  data      Json
  createdAt DateTime @default(now())

  @@index([type])
}

